name: CD

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write
  checks: read

jobs:
  deploy-web:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/setup
      - run: pnpm build
      - name: Setup Pages
        uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b # v5.0.0
      - name: Upload artifact
        uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b # v4.0.0
        with:
          path: './dist'
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5

  # Comprehensive E2E matrix on the deployed build
  e2e-matrix:
    name: E2E Matrix - ${{ matrix.project }}
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.50.0-noble
    needs: [deploy-web]
    strategy:
      fail-fast: false
      matrix:
        project:
          - 'Desktop Chrome'
          - 'Desktop Firefox'
          - 'Desktop Safari'
          - 'iPhone 12 Portrait'
          - 'iPhone 12 Pro Portrait'
          - 'iPhone 13 Portrait'
          - 'iPhone 14 Portrait'
          - 'iPhone 12 Landscape'
          - 'iPad Pro 11 Portrait'
          - 'iPad Pro 11 Landscape'
          - 'iPad Pro 12.9 Portrait'
          - 'Pixel 5 Portrait'
          - 'Pixel 5 Landscape'
          - 'Galaxy S21 Portrait'
          - 'Samsung Galaxy Fold Folded Portrait'
          - 'Samsung Galaxy Fold Folded Landscape'
          - 'Samsung Galaxy Fold Unfolded Portrait'
          - 'Samsung Galaxy Fold Unfolded Landscape'
          - 'Surface Duo Portrait'
          - 'Surface Duo Landscape'
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/setup
      - run: pnpm build
      - name: Set project slug
        id: slug
        run: |
          PROJECT_SLUG=$(echo "${{ matrix.project }}" | sed 's/ /-/g')
          echo "project_slug=${PROJECT_SLUG}" >> $GITHUB_OUTPUT
      - name: Run E2E matrix tests
        run: xvfb-run pnpm exec playwright test --project="${{ matrix.project }}" --workers=1 --reporter=junit,line
        env:
          HOME: /root
          PLAYWRIGHT_JUNIT_OUTPUT_NAME: junit-${{ steps.slug.outputs.project_slug }}.xml
      - name: Upload JUnit test results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: e2e-junit-${{ steps.slug.outputs.project_slug }}
          path: junit-${{ steps.slug.outputs.project_slug }}.xml
          retention-days: 7
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: e2e-reports-${{ steps.slug.outputs.project_slug }}
          path: |
            playwright-report/
            test-results/
          retention-days: 7

  e2e-matrix-collector:
    name: E2E Matrix Results
    runs-on: ubuntu-latest
    if: always()
    needs: [e2e-matrix]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Combine JUnit Reports
        uses: ./.github/actions/combine-junit
        with:
          artifact-pattern: 'e2e-junit-*'
          output-name: 'e2e-junit-combined'
      - name: Check E2E matrix results
        run: |
          echo "E2E Matrix Test Results: ${{ needs.e2e-matrix.result }}"
          if [[ "${{ needs.e2e-matrix.result }}" == "failure" ]]; then
            echo "❌ One or more E2E matrix tests failed"
            exit 1
          fi
          echo "✅ All E2E matrix tests passed"

  build-and-release-android:
    name: Build and Release Android APK
    runs-on: ubuntu-latest
    needs: [deploy-web]
    if: github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/setup
      - uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          distribution: 'temurin'
          java-version: '17'
      - uses: android-actions/setup-android@9fc6c4e9069bf8d3d10b2204b1fb8f6ef7065407 # v3.2.2
      - run: pnpm build:mobile
      - name: Build Debug APK
        run: |
          cd android
          chmod +x ./gradlew
          ./gradlew assembleDebug --stacktrace
      - name: Upload APK as artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: android-debug-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30
