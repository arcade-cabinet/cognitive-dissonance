name: CI

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/setup
      - run: pnpm lint

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/setup
      - run: pnpm exec tsc --noEmit

  unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/setup
      - run: pnpm test:coverage
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: coverage-reports
          path: |
            coverage/
            test-results/
          retention-days: 7

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/setup
      - run: pnpm build
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: dist
          path: dist/
          retention-days: 1

  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [unit]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
      - name: Download coverage reports
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: coverage-reports
      - name: List coverage files
        run: |
          echo "Coverage directory contents:"
          ls -la coverage/ || echo "coverage directory not found"
          echo "Test results directory contents:"
          ls -la test-results/ || echo "test-results directory not found"
      - name: SonarCloud Scan
        uses: sonarsource/sonarqube-scan-action@884b79409bbd464b2a59edc326a4b77dc56b2195 # v3.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  e2e-smoke:
    name: E2E Smoke Tests - Desktop Chrome
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/setup
      - name: Download build artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: dist
          path: dist/
      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium
      - name: Run E2E smoke tests
        run: pnpm exec playwright test --project="Desktop Chrome" --workers=1
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: failure()
        with:
          name: e2e-smoke-reports
          path: playwright-report/
          retention-days: 7

  # Unified E2E matrix: runs every Playwright project exactly once
  e2e-matrix:
    name: E2E - ${{ matrix.project }}
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: [build]
    strategy:
      fail-fast: false
      matrix:
        include:
          # Chromium-based projects
          - { project: 'Desktop Chrome',                          browsers: 'chromium' }
          - { project: 'iPad Pro 11 Portrait',                    browsers: 'chromium' }
          - { project: 'iPad Pro 11 Landscape',                   browsers: 'chromium' }
          - { project: 'iPad Pro 12.9 Portrait',                  browsers: 'chromium' }
          - { project: 'Pixel 5 Portrait',                        browsers: 'chromium' }
          - { project: 'Pixel 5 Landscape',                       browsers: 'chromium' }
          - { project: 'Galaxy S21 Portrait',                     browsers: 'chromium' }
          - { project: 'Samsung Galaxy Fold Folded Portrait',     browsers: 'chromium' }
          - { project: 'Samsung Galaxy Fold Folded Landscape',    browsers: 'chromium' }
          - { project: 'Samsung Galaxy Fold Unfolded Portrait',   browsers: 'chromium' }
          - { project: 'Samsung Galaxy Fold Unfolded Landscape',  browsers: 'chromium' }
          - { project: 'Surface Duo Portrait',                    browsers: 'chromium' }
          - { project: 'Surface Duo Landscape',                   browsers: 'chromium' }
          # WebKit-based projects (iOS devices)
          - { project: 'Desktop Safari',         browsers: 'webkit' }
          - { project: 'iPhone 12 Portrait',     browsers: 'webkit' }
          - { project: 'iPhone 12 Pro Portrait', browsers: 'webkit' }
          - { project: 'iPhone 13 Portrait',     browsers: 'webkit' }
          - { project: 'iPhone 14 Portrait',     browsers: 'webkit' }
          - { project: 'iPhone 12 Landscape',    browsers: 'webkit' }
          # Firefox
          - { project: 'Desktop Firefox',        browsers: 'firefox' }
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/setup
      - name: Download build artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: dist
          path: dist/
      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps ${{ matrix.browsers }}
      - name: Set project slug
        id: slug
        run: |
          PROJECT_SLUG=$(echo "${{ matrix.project }}" | sed 's/ /-/g')
          echo "project_slug=${PROJECT_SLUG}" >> $GITHUB_OUTPUT
      - name: Run E2E tests
        run: pnpm exec playwright test --project="${{ matrix.project }}" --workers=1 --reporter=junit,line
        env:
          PLAYWRIGHT_JUNIT_OUTPUT_NAME: junit-${{ steps.slug.outputs.project_slug }}.xml
      - name: Upload JUnit test results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: e2e-junit-${{ steps.slug.outputs.project_slug }}
          path: junit-${{ steps.slug.outputs.project_slug }}.xml
          retention-days: 7
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: failure()
        with:
          name: e2e-reports-${{ steps.slug.outputs.project_slug }}
          path: playwright-report/
          retention-days: 7

  e2e-collector:
    name: E2E Collector
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [e2e-matrix]
    steps:
      - name: Download all JUnit artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          pattern: e2e-junit-*
          path: junit-results/
          merge-multiple: true
      - name: Combine JUnit reports
        run: |
          mkdir -p combined-junit
          if [ -d "junit-results" ] && compgen -G "junit-results/*.xml" > /dev/null; then
            echo '<?xml version="1.0" encoding="UTF-8"?>' > combined-junit/junit-combined.xml
            echo '<testsuites>' >> combined-junit/junit-combined.xml
            for file in junit-results/*.xml; do
              sed -n '/<testsuite[> ]/,/<\/testsuite>/p' "$file" >> combined-junit/junit-combined.xml
            done
            echo '</testsuites>' >> combined-junit/junit-combined.xml
            echo "Combined JUnit reports successfully"
            ls -la junit-results/
          else
            echo "No JUnit reports found to combine"
          fi
      - name: Upload combined JUnit results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: e2e-junit-combined
          path: combined-junit/
          retention-days: 7
      - name: Check E2E results
        run: |
          echo "E2E Test Results: ${{ needs.e2e-matrix.result }}"
          if [[ "${{ needs.e2e-matrix.result }}" == "failure" ]]; then
            echo "One or more E2E tests failed"
            exit 1
          elif [[ "${{ needs.e2e-matrix.result }}" == "cancelled" ]]; then
            echo "E2E tests were cancelled"
            exit 1
          fi
          echo "All E2E matrix tests passed"

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    if: always()
    needs: [lint, typecheck, unit, build, sonarcloud, e2e-smoke, e2e-collector]
    steps:
      - name: Check CI status
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "Lint failed"
            exit 1
          fi
          if [[ "${{ needs.typecheck.result }}" != "success" ]]; then
            echo "Type check failed"
            exit 1
          fi
          if [[ "${{ needs.unit.result }}" != "success" ]]; then
            echo "Unit tests failed"
            exit 1
          fi
          if [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "Build failed"
            exit 1
          fi
          # SonarCloud runs on PRs only, allow skipped or success
          if [[ "${{ needs.sonarcloud.result }}" != "success" && "${{ needs.sonarcloud.result }}" != "skipped" ]]; then
            echo "SonarCloud analysis failed"
            exit 1
          fi
          # E2E smoke runs on PRs, matrix runs on main pushes
          if [[ "${{ needs.e2e-smoke.result }}" != "success" && "${{ needs.e2e-smoke.result }}" != "skipped" ]]; then
            echo "E2E smoke tests failed"
            exit 1
          fi
          if [[ "${{ needs.e2e-collector.result }}" != "success" && "${{ needs.e2e-collector.result }}" != "skipped" ]]; then
            echo "E2E tests failed"
            exit 1
          fi
          echo "All CI checks passed"

  pr-comment:
    name: Update PR with CI Results
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'
    needs: [lint, typecheck, unit, build, e2e-smoke, ci-success]
    permissions:
      pull-requests: write
    steps:
      - name: Generate CI summary
        id: summary
        run: |
          if [[ "${{ needs.ci-success.result }}" == "success" ]]; then
            STATUS="**CI Passed**"
          else
            STATUS="**CI Failed**"
          fi

          {
            echo "## CI Results for PR #${{ github.event.pull_request.number }}"
            echo ""
            echo "${STATUS}"
            echo ""
            echo "### Job Results"
            echo "| Job | Status |"
            echo "|-----|--------|"
            echo "| Lint | ${{ (needs.lint.result == 'success' && 'Passed') || (needs.lint.result == 'skipped' && 'Skipped') || (needs.lint.result == 'cancelled' && 'Cancelled') || 'Failed' }} |"
            echo "| Type Check | ${{ (needs.typecheck.result == 'success' && 'Passed') || (needs.typecheck.result == 'skipped' && 'Skipped') || (needs.typecheck.result == 'cancelled' && 'Cancelled') || 'Failed' }} |"
            echo "| Unit Tests | ${{ (needs.unit.result == 'success' && 'Passed') || (needs.unit.result == 'skipped' && 'Skipped') || (needs.unit.result == 'cancelled' && 'Cancelled') || 'Failed' }} |"
            echo "| Build | ${{ (needs.build.result == 'success' && 'Passed') || (needs.build.result == 'skipped' && 'Skipped') || (needs.build.result == 'cancelled' && 'Cancelled') || 'Failed' }} |"
            echo "| E2E Smoke Tests | ${{ (needs.e2e-smoke.result == 'success' && 'Passed') || (needs.e2e-smoke.result == 'skipped' && 'Skipped') || (needs.e2e-smoke.result == 'cancelled' && 'Cancelled') || 'Failed' }} |"
            echo ""
            echo "### Quick Actions"
          } > summary.md

          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "- Run \`pnpm lint:fix\` to auto-fix linting issues" >> summary.md
          fi
          if [[ "${{ needs.typecheck.result }}" != "success" ]]; then
            echo "- Run \`pnpm exec tsc --noEmit\` to check types locally" >> summary.md
          fi
          if [[ "${{ needs.unit.result }}" != "success" ]]; then
            echo "- Run \`pnpm test\` to reproduce unit test failures" >> summary.md
          fi
          if [[ "${{ needs.e2e-smoke.result }}" == "failure" ]]; then
            echo "- Run \`pnpm exec playwright test --project=\"Desktop Chrome\"\` to debug E2E tests" >> summary.md
          fi

          if [[ "${{ needs.ci-success.result }}" == "success" ]]; then
            {
              echo ""
              echo "---"
              echo "_This PR is ready for review! All checks have passed._"
            } >> summary.md
          else
            {
              echo ""
              echo "---"
              echo "_Please fix the failing checks before requesting review._"
            } >> summary.md
          fi

      - name: Post or update PR comment
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('summary.md', 'utf8');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('CI Results for PR')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: summary
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }
